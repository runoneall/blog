<!DOCTYPE html>
<html lang="zh">
    <head>
        <!-- base -->
<meta charset="UTF-8" />
<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="template" content="Old-Fasion-Theme" />

<!-- sitemap -->
<link
    rel="sitemap"
    type="application/xml"
    title="sitemap"
    href="/sitemap.xml"
/>

<!-- title -->
<title>
    基于深度学习的离线tts和stt的python实现 | Runoneall
</title>

<!-- css dependencies -->

<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/grid.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/global.css">
<link rel="stylesheet" href="/css/sidebar.css">
<link rel="stylesheet" href="/css/post.css">
<link rel="stylesheet" href="/css/misc.css">
<link rel="stylesheet" href="/css/page.css">
<link rel="stylesheet" href="/css/footer.css">
<link rel="stylesheet" href="/css/dark.css" id="dark-style" disabled>


<!-- favicon -->
<link rel="shortcut icon" href="https://dev.oneall.eu.org/favicon.webp">

<!-- extra css -->


<!-- keywords -->

<meta name="keywords" content="Hexo,Blog,Runoneall" />

<!-- description -->

<meta name="description" content="安装模型（stt用的vosk-model-cn-0.22，tts用的kokoro-v1.1-zh） # vosk-model-cn-0.22 wget https://alphacephei.com/vosk/models/vosk-model-cn-0.22.zip unzip vosk-model-cn-0.22.zip rm vosk-model-cn-0.22.zip  # kokoro-" />

<!-- rss -->
<link rel="alternate" href="/rss2.xml" title="RSS 2.0" type="application/application/rss+xml+xml">
<link rel="alternate" href="/atom.xml" title="ATOM 1.0" type="application/application/atom+xml+xml">

    <meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Runoneall" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Runoneall" type="application/rss+xml">
</head>

    <body>
        <div id="outbox">
            <!-- header -->
            <div id="header" class="clearfix">
                <div class="container">
                    <div class="row">
                        <div class="site-name">
                            <a id="logo" href="/"
                                >Runoneall</a
                            >
                            <p
                                id="description_random_intro"
                                class="description"
                            >
                                Runoneall's Blog
                            </p>
                            <script>
                                var description_random_intro =
                                    document.getElementById(
                                        "description_random_intro",
                                    );
                                var descriptions = JSON.parse(
                                    `["路漫漫其修远兮，吾将上下而求索","天将降大任于是人也，必先苦其心志，劳其筋骨，饿其体肤，空乏其身，行拂乱其所为","惜秦皇汉武，略输文采；唐宗宋祖，稍逊风骚。俱往矣，数风流人物，还看今朝。"]`,
                                );
                                var random_intro =
                                    descriptions[
                                        Math.floor(
                                            Math.random() * descriptions.length,
                                        )
                                    ];
                                description_random_intro.innerHTML =
                                    random_intro;
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end header -->

            <!-- sidebar button -->
            <button id="side-btn" onclick="changeSideStatus()">
                <input id="side-flag" type="checkbox" />
                <label id="side-control" for="side-flag">≡</label>
            </button>

            <!-- left area -->
            <div id="left">
                <!-- left links -->
                <div id="left-links">
                    <!-- page links -->
                    <a
                        class=""
                        href="/"
                        >首页</a
                    >
                    
                    <br />
                    <a
                        class=""
                        href="/about/index.html"
                        >关于</a
                    >
                    
                    <br />
                    <a
                        class=""
                        href="/links/index.html"
                        >链接</a
                    >
                    
                    <br />
                    <a
                        class=""
                        href="/search/index.html"
                        >搜索</a
                    >
                    
                    <!-- end page links -->

                    <!-- sidebar extra html -->
                    
                    <br />
                    <a href="/rss2.xml">RSS</a><br>
<a href="mailto:dev@oneall.eu.org">Email</a><br>
                    
                    <!-- end sidebar extra html -->

                    <br /><button id="dark-btn" onclick="changeDarkMode()">
                        更换主题
                    </button>
                </div>
                <!-- end left links -->
            </div>
            <!-- end left area -->

            <!-- right area -->
            <div id="right">
                <div class="row"><div class="col-mb-12 col-8" id="main" role="main">
    <!-- article body -->
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
        <!-- post title -->
        <h1 class="post-title" itemprop="name headline">
            <a itemprop="url" href="/2025/04/06/%E5%9F%BA%E4%BA%8E%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%9A%84%E7%A6%BB%E7%BA%BFtts%E5%92%8Cstt%E7%9A%84python%E5%AE%9E%E7%8E%B0/"
                >基于深度学习的离线tts和stt的python实现</a
            >
        </h1>
        <!-- end post title -->

        <!-- post meta -->
        <ul class="post-meta">
            <li itemprop="author" itemscope itemtype="http://schema.org/Person">
                作者:
                <a itemprop="name" href="#" rel="author"
                    >Tom Brown</a
                >
            </li>
            <li>
                时间:
                <time
                    itemprop="datePublished"
                    datetime="2025-04-06T05:05:00.000Z"
                    >2025-04-06</time
                >
            </li>
            
            <li>
                分类: 
                <a href="/categories/%E9%BB%98%E8%AE%A4/">
                    默认 </a
                >&nbsp;
                
            </li>
            
        </ul>
        <!-- end post meta -->

        <!-- post content -->
        <div class="post-content" itemprop="articleBody">
            <p>安装模型（stt用的vosk-model-cn-0.22，tts用的kokoro-v1.1-zh）</p>
<pre><code class="language-zsh"># vosk-model-cn-0.22
wget https://alphacephei.com/vosk/models/vosk-model-cn-0.22.zip
unzip vosk-model-cn-0.22.zip
rm vosk-model-cn-0.22.zip

# kokoro-v1.1-zh
mkdir kokoro-v1.1-zh
cd kokoro-v1.1-zh
wget https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.1/kokoro-v1.1-zh.onnx
wget https://github.com/thewh1teagle/kokoro-onnx/releases/download/model-files-v1.1/voices-v1.1-zh.bin
wget https://huggingface.co/hexgrad/Kokoro-82M-v1.1-zh/raw/main/config.json
cd ..
</code></pre>
<p>安装依赖</p>
<pre><code class="language-plaintext">addict==2.4.0
annotated-types==0.7.0
anyio==4.9.0
attrs==25.3.0
babel==2.17.0
certifi==2025.1.31
cffi==1.17.1
charset-normalizer==3.4.1
cn2an==0.5.23
colorama==0.4.6
coloredlogs==15.0.1
colorlog==6.9.0
csvw==3.5.1
distro==1.9.0
dlinfo==2.0.0
espeakng-loader==0.2.4
exceptiongroup==1.2.2
flatbuffers==25.2.10
h11==0.14.0
httpcore==1.0.7
httpx==0.28.1
humanfriendly==10.0
idna==3.10
isodate==0.7.2
jieba==0.42.1
jiter==0.9.0
joblib==1.4.2
jsonschema==4.23.0
jsonschema-specifications==2024.10.1
kokoro-onnx==0.4.7
language-tags==1.2.0
misaki==0.9.3
mpmath==1.3.0
numpy==2.2.4
onnxruntime==1.21.0
openai==1.70.0
ordered-set==4.1.0
packaging==24.2
phonemizer-fork==3.3.1
proces==0.1.7
protobuf==6.30.2
PyAudio==0.2.14
pycparser==2.22
pydantic==2.11.2
pydantic_core==2.33.1
pyparsing==3.2.3
pypinyin==0.54.0
pypinyin-dict==0.9.0
python-dateutil==2.9.0.post0
rdflib==7.1.4
referencing==0.36.2
regex==2024.11.6
requests==2.32.3
rfc3986==1.5.0
rpds-py==0.24.0
segments==2.3.0
six==1.17.0
sniffio==1.3.1
sounddevice==0.5.1
srt==3.5.3
sympy==1.13.3
tqdm==4.67.1
typing-inspection==0.4.0
typing_extensions==4.13.1
uritemplate==4.1.1
urllib3==2.3.0
vosk==0.3.44
websockets==15.0.1
</code></pre>
<p>tts.py</p>
<pre><code class="language-python">import sounddevice as sd
import kokoro_onnx as kokoro
from misaki import zh
import asyncio

kokoro.MAX_PHONEME_LENGTH = 80


class TTS:
    def __init__(self):
        self.g2p = zh.ZHG2P(version=&quot;1.1&quot;)
        self.voice = &quot;zm_009&quot;
        self.speed = 1.0
        self.model = kokoro.Kokoro(
            &quot;kokoro-v1.1-zh/model.onnx&quot;,
            &quot;kokoro-v1.1-zh/voices.bin&quot;,
            vocab_config=&quot;kokoro-v1.1-zh/config.json&quot;,
        )
        self.model.create(
            self.get_phonemes(&quot;你好，世界！&quot;),
            voice=self.voice,
            speed=self.speed,
            is_phonemes=True,
        )
        print(&quot;TTS initialized&quot;)

    def set_speed(self, speed: float = 1.0):
        self.speed = speed

    def get_phonemes(self, text: str) -&gt; str:
        phonemes, _ = self.g2p(text)
        return phonemes

    def speak(self, text: str):
        async def stream_audio():
            stream = self.model.create_stream(
                self.get_phonemes(text),
                voice=self.voice,
                speed=self.speed,
                is_phonemes=True,
            )
            async for audio, audio_rate in stream:
                sd.play(audio, audio_rate)
                sd.wait()

        asyncio.run(stream_audio())
</code></pre>
<p>stt.py</p>
<pre><code class="language-python">import json
import vosk
import pyaudio


class STT:
    def __init__(self):
        self.recognizer = vosk.KaldiRecognizer(vosk.Model(&quot;vosk-model-cn-0.22&quot;), 16000)
        self.mic = pyaudio.PyAudio()
        self.stream = self.mic.open(
            format=pyaudio.paInt16,
            channels=1,
            rate=16000,
            input=True,
            frames_per_buffer=4096,
        )
        self.stop_listening = False
        print(&quot;STT initialized&quot;)

    def listen(self, on_result: callable):
        while not self.stop_listening:
            if self.recognizer.AcceptWaveform(
                self.stream.read(4096, exception_on_overflow=False)
            ):
                result = json.loads(self.recognizer.Result())
                text: str = result.get(&quot;text&quot;, &quot;&quot;)
                if text:
                    on_result(text.replace(&quot; &quot;, &quot;&quot;))
        self.stream.stop_stream()
        self.stream.close()
        self.mic.terminate()

    def stop(self):
        self.stop_listening = True
</code></pre>
<p>用法</p>
<pre><code class="language-python">import tts
import stt

tts_engine = tts.TTS()
stt_engine = stt.STT()

def call(text: str):
    tts_engine.speak(text)
    # your logic
    #stt_engine.stop()  # stop mic listen

stt_engine.listen(call)  # start mic listen
</code></pre>

        </div>
        <!-- end post content -->
    </article>
    <!-- end article body -->
</div>
</div>
            </div>
            <!-- end right area -->

            <!-- footer -->
            <div id="footer" role="contentinfo">
                &copy; 2025
                <a href="/">Runoneall</a>.
                <a
                    target="_blank" rel="noopener" href="https://github.com/runoneall/blog/tree/main/themes/hexo-theme-old-fashion"
                    >Old Fasion</a
                >
                Theme. Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>.
            </div>
            <!-- end footer -->
        </div>
        <!-- end outbox -->

        <!-- extra html -->


<!-- extra js -->

<script>
    console.log(String.raw`
            ___              __
      _____<  /____ _   ____/ /___  _   __
     / ___// // __ `+ "`" + String.raw`/  / __  // _ \| | / /
    / /   / // /_/ /  / /_/ //  __/| |/ /
   /_/   /_/ \__,_/   \__,_/ \___/ |___/

LET THE UNFAIRNESS OF THE WORLD BOW BEFORE ME
`)
</script>


<!-- js dependencies -->

<script src="/js/dark.js"></script>
<script src="/js/highlight.js"></script>
<script src="/js/sidebar.js"></script>


<!-- code highlight -->
<script>
    hljs.highlightAll();
</script>

    </body>
</html>
