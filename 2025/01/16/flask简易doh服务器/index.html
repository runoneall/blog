<!DOCTYPE html>
<html lang="zh">

    <head>
        <!-- base -->
<meta charset="UTF-8" />
<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="template" content="Old-Fasion-Theme" />

<!-- sitemap -->
<link
    rel="sitemap"
    type="application/xml"
    title="sitemap"
    href="/sitemap.xml" />

<!-- title -->
<title>
    flask简易doh服务器 | Runoneall
</title>

<!-- css dependencies -->

<link rel="stylesheet" href="/css/normalize.css">
<link rel="stylesheet" href="/css/grid.css">
<link rel="stylesheet" href="/css/highlight.css">
<link rel="stylesheet" href="/css/global.css">
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/sidebar.css">
<link rel="stylesheet" href="/css/post.css">
<link rel="stylesheet" href="/css/misc.css">
<link rel="stylesheet" href="/css/page.css">
<link rel="stylesheet" href="/css/footer.css">
<link rel="stylesheet" href="/css/dark.css" id="dark-style" disabled>


<!-- favicon -->
<link rel="shortcut icon" href="https://dev.oneall.eu.org/favicon.webp">

<!-- extra css -->


<!-- keywords -->

<meta name="keywords" content="Hexo,Blog,Runoneall" />

<!-- description -->

<meta name="description" content="import base64 import socket import random from urllib import request as urllib_request from urllib import parse as urllib_parse from flask import Flask, make_response from flask import request as flas" />

<!-- rss -->
<link rel="alternate" href="/rss2.xml" title="RSS 2.0" type="application/application/rss+xml+xml">
<link rel="alternate" href="/atom.xml" title="ATOM 1.0" type="application/application/atom+xml+xml">
    <meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Runoneall" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Runoneall" type="application/rss+xml">
</head>

    <body>
        <div id="outbox">
            <!-- header -->
            <div id="header" class="clearfix">
                <div class="container">
                    <div class="row">
                        <div class="site-name">
                            <a id="logo" href="/">Runoneall</a>
                            <p id="description_random_intro"
                                class="description">
                                Runoneall's Blog
                            </p>
                            <script>
var description_random_intro = document.getElementById("description_random_intro");
var descriptions = JSON.parse(`["路漫漫其修远兮，吾将上下而求索","天将降大任于是人也，必先苦其心志，劳其筋骨，饿其体肤，空乏其身，行拂乱其所为","惜秦皇汉武，略输文采；唐宗宋祖，稍逊风骚。俱往矣，数风流人物，还看今朝。"]`);
var random_intro = descriptions[Math.floor(Math.random() * descriptions.length)];
description_random_intro.innerHTML = random_intro;
                            </script>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end header -->

            <!-- sidebar button -->
            <button id="side-btn" onclick="changeSideStatus()">
                <input id="side-flag" type="checkbox" />
                <label id="side-control" for="side-flag">≡</label>
            </button>

            <!-- left area -->
            <div id="left">
                <!-- left links -->
                <div id="left-links">
                    <!-- page links -->
                    <a
                        class=""
                        href="/">首页</a>
                    
                    <br />
                    <a class=""
                        href="/about/index.html">About</a>
                    
                    <br />
                    <a class=""
                        href="/links/index.html">Links</a>
                    
                    <!-- end page links -->

                    <!-- sidebar extra html -->
                    
                    <br />
                    <a href="/rss2.xml">RSS</a><br>
<a href="mailto:email@example.com">Email</a><br>
                    
                    <!-- end sidebar extra html -->

                    <button id="dark-btn"
                        onclick="changeDarkMode()">更换主题</button>
                </div><hr>
                <!-- end left links -->

                <!-- search -->
                <form id="search" method="get" action="#" role="search">
                    <input type="text" id="s" name="s" class="text"
                        placeholder="输入关键字搜索" />
                    <button type="submit" class="submit">
                        <img src="/img/icon-search.png"
                            alt="icon-search">
                    </button>
                </form>
                <!-- end search -->

            </div>
            <!-- end left area -->

            <!-- right area -->
            <div id="right">
                <div class="row">
                    <div class="col-mb-12 col-8" id="main" role="main">

    <!-- article body -->
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

        <!-- post title -->
        <h1 class="post-title" itemprop="name headline">
            <a itemprop="url" href="/2025/01/16/flask%E7%AE%80%E6%98%93doh%E6%9C%8D%E5%8A%A1%E5%99%A8/">flask简易doh服务器</a>
        </h1>
        <!-- end post title -->

        <!-- post meta -->
        <ul class="post-meta">
            <li itemprop="author" itemscope itemtype="http://schema.org/Person">
                作者: <a itemprop="name" href="#" rel="author">Tom Brown</a>
            </li>
            <li>时间:
                <time itemprop="datePublished"
                    datetime="2025-01-16T16:46:00.000Z">2025-01-16</time>
            </li>
            
            <li>分类:
                
                <a href="/categories/%E9%BB%98%E8%AE%A4%E5%88%86%E7%B1%BB/">
                    默认分类
                </a>&nbsp;
                
            </li>
            
        </ul>
        <!-- end post meta -->

        <!-- post content -->
        <div class="post-content" itemprop="articleBody">
            <pre><code class="language-python">import base64
import socket
import random
from urllib import request as urllib_request
from urllib import parse as urllib_parse
from flask import Flask, make_response
from flask import request as flask_request

app = Flask(__name__)
socket.setdefaulttimeout(5)
dnss = [
    &quot;8.8.8.8&quot;,
    &quot;8.8.4.4&quot;,
    &quot;1.1.1.1&quot;,
    &quot;1.0.0.1&quot;
]
jsonapis = [
    &quot;https://cloudflare-dns.com/dns-query&quot;,
    &quot;https://dns.google/resolve&quot;
]

def send_dns_query(dns_query: bytes) -&gt; bytes:
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.sendto(dns_query, (random.choice(dnss), 53))
    rx, _ = sock.recvfrom(4096)
    sock.close()
    return rx

@app.route(&quot;/dns-query&quot;, methods=[&quot;GET&quot;, &quot;POST&quot;])
def dns_query():
    if &quot;Content-Type&quot; not in flask_request.headers or flask_request.headers[&quot;Content-Type&quot;] != &quot;application/dns-message&quot;:
        return make_response(&quot;Invalid Content-Type&quot;, 400, &#123;&quot;Content-Type&quot;: &quot;text/plain; charset=utf-8&quot;&#125;)
    if flask_request.method == &quot;GET&quot;:
        dns_query = base64.urlsafe_b64decode(flask_request.args.get(&quot;dns&quot;) + &quot;===&quot;)
        dns_response = send_dns_query(dns_query)
        return make_response(dns_response, 200, &#123;&quot;Content-Type&quot;: &quot;application/dns-message&quot;&#125;)
    if flask_request.method == &quot;POST&quot;:
        dns_query = flask_request.stream.read()
        dns_response = send_dns_query(dns_query)
        return make_response(dns_response, 200, &#123;&quot;Content-Type&quot;: &quot;application/dns-message&quot;&#125;)
    return make_response(&quot;Invalid Method&quot;, 405, &#123;&quot;Content-Type&quot;: &quot;text/plain; charset=utf-8&quot;&#125;)

@app.route(&quot;/resolve&quot;, methods=[&quot;GET&quot;])
def dns_json():
    if &quot;Accept&quot; not in flask_request.headers or flask_request.headers[&quot;Accept&quot;] != &quot;application/dns-json&quot;:
        return make_response(&quot;Invalid Accept&quot;, 400, &#123;&quot;Content-Type&quot;: &quot;text/plain; charset=utf-8&quot;&#125;)
    target_domain = flask_request.args.get(&quot;name&quot;)
    target_type = flask_request.args.get(&quot;type&quot;)
    if not target_domain or not target_type:
        return make_response(&quot;Invalid Request&quot;, 400, &#123;&quot;Content-Type&quot;: &quot;text/plain; charset=utf-8&quot;&#125;)
    query_url = random.choice(jsonapis) + &quot;?name=&quot; + urllib_parse.quote(target_domain) + &quot;&amp;type=&quot; + urllib_parse.quote(target_type)
    req_headers = &#123;&quot;Accept&quot;: &quot;application/dns-json&quot;&#125;
    req = urllib_request.Request(query_url, headers=req_headers)
    rep = urllib_request.urlopen(req)
    rep_status = rep.getcode()
    rep_content_type = rep.headers.get(&#39;Content-Type&#39;)
    rep_body = rep.read()
    rep.close()
    return make_response(rep_body, rep_status, &#123;&quot;Content-Type&quot;: rep_content_type&#125;)

if __name__ == &quot;__main__&quot;:
    app.run()
</code></pre>
<p>全类型支持：普通dns查询，jsonapi<br>普通dns查询地址：<code>/dns-query</code><br>jsonapi查询地址：<code>/resolve</code></p>
<p>demo：<a target="_blank" rel="noopener" href="https://doh.xserver.rr.nu/">https://doh.xserver.rr.nu</a></p>

        </div>
        <!-- end post content -->

    </article>
    <!-- end article body -->

</div>
                </div>
            </div>
            <!-- end right area -->

            <!-- footer -->
            <div id="footer" role="contentinfo">
                &copy; 2025
                <a href="/">Runoneall</a>.
                <a
                    target="_blank" rel="noopener" href="https://github.com/runoneall/hexo-theme-old-fashion">Old
                    Fasion</a>
                Theme. Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>.
            </div>
            <!-- end footer -->
        </div>
        <!-- end outbox -->

        <!-- extra html -->


<!-- extra js -->

<script>
console.log(String.raw`
            ___              __
      _____<  /____ _   ____/ /___  _   __
     / ___// // __ `+ "`" + String.raw`/  / __  // _ \| | / /
    / /   / // /_/ /  / /_/ //  __/| |/ /
   /_/   /_/ \__,_/   \__,_/ \___/ |___/

LET THE UNFAIRNESS OF THE WORLD BOW BEFORE ME
`)
</script>


<!-- js dependencies -->

<script src="/js/dark.js"></script>
<script src="/js/highlight.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/search.js"></script>


<!-- code highlight -->
<script>
    hljs.highlightAll();
</script>
    </body>

</html>